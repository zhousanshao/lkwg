<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ´›å…‹ç‹å›½ - å® ç‰©å›¾é‰´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <!-- é…ç½®Tailwindè‡ªå®šä¹‰ä¸»é¢˜ -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#7B61FF',
            fire: '#FF6B35',
            water: '#35A7FF',
            grass: '#36B37E',
            electric: '#FFD600',
            ice: '#64D2FF',
            martial: '#FF5630',
            poison: '#A335EE',
            earth: '#9E7C14',
            wing: '#00B8D9',
            cute: '#FF568B',
            insect: '#899300',
            stone: '#8B7765',
            ghost: '#6554C0',
            dragon: '#0076D1',
            devil: '#5E2BFF',
            mechanical: '#6B778C',
            light: '#FFDD00',
            normal: '#9DA0AA',
            godgrass: '#26C6DA'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .pet-card-gradient {
        background: linear-gradient(135deg, var(--tw-gradient-from) 0%, var(--tw-gradient-to) 100%);
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 20px rgba(0,0,0,0.1);
      }
      .filter-btn {
        transition: all 0.2s ease;
      }
      .filter-btn:hover {
        transform: translateY(-2px);
      }
      .filter-btn.active {
        box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
  <!-- å¯¼èˆªæ  -->
  <header class="sticky top-0 z-50 bg-white shadow-sm transition-all duration-300" id="navbar">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <img src="https://tse3-mm.cn.bing.net/th/id/OIP-C.jC_LHaOlSGAY6IZ4eY5ySgHaGM?w=211&h=180&c=7&r=0&o=7&dpr=1.5&pid=1.7&rm=3" alt="æ´›å…‹ç‹å›½" class="w-10 h-10 rounded-full">
        <h1 class="text-2xl font-bold text-primary">æ´›å…‹ç‹å›½</h1>
      </div>
      
      <nav class="hidden md:flex items-center space-x-6">
        <a href="#" class="text-primary font-medium border-b-2 border-primary pb-1">å® ç‰©å›¾é‰´</a>
        <a href="#" class="text-gray-600 hover:text-primary transition-colors">å® ç‰©æŠ€èƒ½</a>
        <a href="#" class="text-gray-600 hover:text-primary transition-colors">æˆ˜æ–—æ”»ç•¥</a>
        <a href="#" class="text-gray-600 hover:text-primary transition-colors">æ¸¸æˆèµ„è®¯</a>
      </nav>
      
      <button class="md:hidden text-gray-600" id="mobile-menu-button">
        <i class="fa fa-bars text-xl"></i>
      </button>
    </div>
    
    <!-- ç§»åŠ¨ç«¯èœå• -->
    <div class="md:hidden hidden bg-white border-t" id="mobile-menu">
      <div class="container mx-auto px-4 py-2 flex flex-col space-y-3">
        <a href="#" class="py-2 text-primary font-medium">å® ç‰©å›¾é‰´</a>
        <a href="#" class="py-2 text-gray-600 hover:text-primary transition-colors">å® ç‰©æŠ€èƒ½</a>
        <a href="#" class="py-2 text-gray-600 hover:text-primary transition-colors">æˆ˜æ–—æ”»ç•¥</a>
        <a href="#" class="py-2 text-gray-600 hover:text-primary transition-colors">æ¸¸æˆèµ„è®¯</a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- é¡µé¢æ ‡é¢˜å’Œç­›é€‰åŒº -->
    <div class="mb-8">
      <h2 class="text-3xl font-bold mb-6 text-shadow">å® ç‰©å›¾é‰´</h2>
      
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
        <div class="relative w-full md:w-64">
          <input type="text" id="search-input" placeholder="æœç´¢å® ç‰©..." 
                 class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
          <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
        
        <div class="flex flex-wrap gap-2 w-full md:w-auto justify-start md:justify-end">
          <button id="magic-filter" class="filter-btn bg-white border border-gray-300 rounded-lg px-4 py-2 flex items-center gap-2 hover:border-primary hover:text-primary">
            <i class="fa fa-star text-yellow-400"></i>
            <span>é­”åŠ›å€¼å® ç‰©</span>
          </button>
          
          <div class="relative">
            <select id="sort-select" class="appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all">
              <option value="id-asc">æŒ‰ç¼–å·: ä»å°åˆ°å¤§</option>
              <option value="id-desc">æŒ‰ç¼–å·: ä»å¤§åˆ°å°</option>
              <option value="power-asc">æŒ‰é­”åŠ›å€¼: ä»ä½åˆ°é«˜</option>
              <option value="power-desc">æŒ‰é­”åŠ›å€¼: ä»é«˜åˆ°ä½</option>
              <option value="sum-asc">æŒ‰æ€»å’Œ: ä»ä½åˆ°é«˜</option>
              <option value="sum-desc">æŒ‰æ€»å’Œ: ä»é«˜åˆ°ä½</option>
            </select>
            <i class="fa fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
          </div>
        </div>
        <!-- æˆ‘çš„æˆ˜é˜Ÿé¡¶éƒ¨å¿«æ·æ˜¾ç¤º -->
        <div class="w-full flex justify-end mt-3 md:mt-0">
          <div id="team-summary" class="text-sm text-white bg-primary/90 rounded-full px-3 py-1 flex items-center gap-3">
            <span id="team-count">é˜Ÿä¼ 0/6</span>
            <span id="team-magic">é­”åŠ›: 0</span>
            <button id="team-toggle" class="bg-white/20 hover:bg-white/30 rounded px-2 py-1 text-xs">æŸ¥çœ‹</button>
          </div>
        </div>
      </div>
      
      <!-- å±æ€§ç­›é€‰æ ‡ç­¾ -->
      <div class="flex flex-wrap gap-2 mb-8">
        <button class="filter-btn active bg-primary text-white rounded-full px-4 py-2 text-sm" data-type="all">å…¨éƒ¨</button>
        <button class="filter-btn bg-fire text-white rounded-full px-4 py-2 text-sm" data-type="fire">ç«ç³»</button>
        <button class="filter-btn bg-water text-white rounded-full px-4 py-2 text-sm" data-type="water">æ°´ç³»</button>
        <button class="filter-btn bg-grass text-white rounded-full px-4 py-2 text-sm" data-type="grass">è‰ç³»</button>
        <button class="filter-btn bg-electric text-white rounded-full px-4 py-2 text-sm" data-type="electric">ç”µç³»</button>
        <button class="filter-btn bg-ice text-white rounded-full px-4 py-2 text-sm" data-type="ice">å†°ç³»</button>
        <button class="filter-btn bg-martial text-white rounded-full px-4 py-2 text-sm" data-type="martial">æ­¦ç³»</button>
        <button class="filter-btn bg-poison text-white rounded-full px-4 py-2 text-sm" data-type="poison">æ¯’ç³»</button>
        <button class="filter-btn bg-earth text-white rounded-full px-4 py-2 text-sm" data-type="earth">åœŸç³»</button>
        <button class="filter-btn bg-wing text-white rounded-full px-4 py-2 text-sm" data-type="wing">ç¿¼ç³»</button>
        <button class="filter-btn bg-cute text-white rounded-full px-4 py-2 text-sm" data-type="cute">èŒç³»</button>
        <button class="filter-btn bg-insect text-white rounded-full px-4 py-2 text-sm" data-type="insect">è™«ç³»</button>
        <button class="filter-btn bg-stone text-white rounded-full px-4 py-2 text-sm" data-type="stone">çŸ³ç³»</button>
        <button class="filter-btn bg-ghost text-white rounded-full px-4 py-2 text-sm" data-type="ghost">å¹½çµç³»</button>
        <button class="filter-btn bg-dragon text-white rounded-full px-4 py-2 text-sm" data-type="dragon">é¾™ç³»</button>
        <button class="filter-btn bg-devil text-white rounded-full px-4 py-2 text-sm" data-type="devil">æ¶é­”ç³»</button>
        <button class="filter-btn bg-mechanical text-white rounded-full px-4 py-2 text-sm" data-type="mechanical">æœºæ¢°ç³»</button>
        <button class="filter-btn bg-light text-white rounded-full px-4 py-2 text-sm" data-type="light">å…‰ç³»</button>
        <button class="filter-btn bg-normal text-white rounded-full px-4 py-2 text-sm" data-type="normal">æ™®é€šç³»</button>
        <button class="filter-btn bg-godgrass text-white rounded-full px-4 py-2 text-sm" data-type="godgrass">ç¥è‰ç³»</button>
      </div>
    </div>
    
    <!-- å® ç‰©å¡ç‰‡ç½‘æ ¼ -->
    <div id="pets-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
      <!-- å® ç‰©å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      <div class="col-span-full text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary"></div>
        <p class="mt-4 text-gray-500">åŠ è½½å® ç‰©æ•°æ®ä¸­...</p>
      </div>
    </div>
    
    <!-- ç©ºçŠ¶æ€æ˜¾ç¤º -->
    <div id="empty-state" class="hidden col-span-full text-center py-16">
      <img src="https://picsum.photos/120/120" alt="æ²¡æœ‰æ‰¾åˆ°å® ç‰©" class="mx-auto w-32 h-32 opacity-30 mb-4">
      <h3 class="text-xl font-medium text-gray-500">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å® ç‰©</h3>
      <p class="text-gray-400 mt-2">è¯·å°è¯•å…¶ä»–æœç´¢æ¡ä»¶æˆ–ç­›é€‰æ¡ä»¶</p>
    </div>
  </main>

  <!-- å® ç‰©è¯¦æƒ…æ¨¡æ€æ¡† -->
  <div id="pet-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="modal-backdrop"></div>
    <div class="relative bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all scale-95 opacity-0" id="modal-content">
      <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 z-10 bg-white/80 rounded-full w-8 h-8 flex items-center justify-center backdrop-blur-sm">
        <i class="fa fa-times"></i>
      </button>
      
      <div class="p-6 md:p-8" id="modal-body">
        <!-- æ¨¡æ€æ¡†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <footer class="bg-gray-800 text-white mt-16">
    <div class="container mx-auto px-4 py-10">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div class="mb-6 md:mb-0">
          <div class="flex items-center space-x-2">
            <img src="https://picsum.photos/40/40" alt="æ´›å…‹ç‹å›½" class="w-8 h-8 rounded-full">
            <span class="text-lg font-bold">æ´›å…‹ç‹å›½</span>
          </div>
          <p class="text-gray-400 text-sm mt-2">å® ç‰©å›¾é‰´ - æ¢ç´¢æ´›å…‹ç‹å›½çš„å¥‡å¦™ç”Ÿç‰©</p>
        </div>
        
        <div class="flex items-center space-x-4">
          <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="fa fa-weibo text-xl"></i></a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="fa fa-wechat text-xl"></i></a>
          <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="fa fa-qq text-xl"></i></a>
        </div>
      </div>
      
      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400 text-sm">
        <p>Â© 2023 æ´›å…‹ç‹å›½ ç‰ˆæƒæ‰€æœ‰</p>
      </div>
    </div>
  </footer>

  <!-- æˆ˜é˜Ÿé¢æ¿ï¼ˆå³ä¸‹ï¼‰ -->
  <div id="team-panel" class="fixed right-6 bottom-6 w-72 bg-white rounded-xl shadow-lg p-3 z-50 hidden">
    <div class="flex justify-between items-center mb-2">
      <h4 class="font-semibold">æˆ‘çš„æˆ˜é˜Ÿ <span id="panel-count" class="text-gray-500">(0/6)</span></h4>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">é­”åŠ›ï¼š</span>
        <span id="panel-magic" class="font-medium">0</span>
      </div>
    </div>

    <div id="team-list" class="grid grid-cols-3 gap-2 mb-3">
      <!-- ç¼©ç•¥å›¾å°†ç”±JSæ¸²æŸ“ -->
    </div>

    <div class="flex justify-between">
      <button id="clear-team" class="text-sm text-red-500 hover:underline">æ¸…ç©º</button>
      <button id="close-team" class="text-sm text-gray-600 hover:underline">å…³é—­</button>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let petsData = [];
    let filteredPets = [];
    let currentFilter = 'all';
    let magicFilterActive = false;
    let searchQuery = '';
    let sortOrder = 'id-asc';
    // æˆ‘çš„æˆ˜é˜Ÿæ•°æ®
    let myTeam = [];
    const maxTeamSize = 6;
    let modalChart = null;
    // ç±»å‹å›¾æ ‡ä¸æ˜ å°„ï¼ˆç”¨äºå¡ç‰‡ä¸ç­›é€‰æŒ‰é’®ï¼‰
    const typeIconMap = {
      'ç«': 'ğŸ”¥', 'æ°´': 'ğŸ’§', 'è‰': 'ğŸƒ', 'ç”µ': 'âš¡', 'å†°': 'â„ï¸', 'æ­¦': 'ğŸ¥‹', 'æ¯’': 'â˜ ï¸', 'åœŸ': 'ğŸŒ', 'ç¿¼': 'ğŸ¦', 'èŒ': 'ğŸ˜»',
      'è™«': 'ğŸ', 'çŸ³': 'ğŸª¨', 'å¹½çµ': 'ğŸ‘»', 'é¾™': 'ğŸ‰', 'æ¶é­”': 'ğŸ˜ˆ', 'æœºæ¢°': 'âš™ï¸', 'å…‰': 'ğŸ’¡', 'æ™®é€š': 'â­', 'ç¥è‰': 'ğŸŒ¿'
    };
    const dataTypeToChinese = {
      'fire': 'ç«', 'water': 'æ°´', 'grass': 'è‰', 'electric': 'ç”µ', 'ice': 'å†°', 'martial': 'æ­¦', 'poison': 'æ¯’',
      'earth': 'åœŸ', 'wing': 'ç¿¼', 'cute': 'èŒ', 'insect': 'è™«', 'stone': 'çŸ³', 'ghost': 'å¹½çµ', 'dragon': 'é¾™',
      'devil': 'æ¶é­”', 'mechanical': 'æœºæ¢°', 'light': 'å…‰', 'normal': 'æ™®é€š', 'godgrass': 'ç¥è‰'
    };
    
    // DOM å…ƒç´ 
    const petsGrid = document.getElementById('pets-grid');
    const emptyState = document.getElementById('empty-state');
    const searchInput = document.getElementById('search-input');
    const magicFilterBtn = document.getElementById('magic-filter');
    const sortSelect = document.getElementById('sort-select');
    const filterButtons = document.querySelectorAll('.filter-btn[data-type]');
    const navbar = document.getElementById('navbar');
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const petModal = document.getElementById('pet-modal');
    const modalContent = document.getElementById('modal-content');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const closeModal = document.getElementById('close-modal');
    const modalBody = document.getElementById('modal-body');
    const teamSummary = document.getElementById('team-summary');
    const teamCountEl = document.getElementById('team-count');
    const teamMagicEl = document.getElementById('team-magic');
    const teamPanel = document.getElementById('team-panel');
    const teamListEl = document.getElementById('team-list');
    const panelCount = document.getElementById('panel-count');
    const panelMagic = document.getElementById('panel-magic');
    const teamToggle = document.getElementById('team-toggle');
    const clearTeamBtn = document.getElementById('clear-team');
    const closeTeamBtn = document.getElementById('close-team');
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // åŠ è½½å® ç‰©æ•°æ®
      loadPetsData();
      
      // äº‹ä»¶ç›‘å¬
      setupEventListeners();
    });
    
    // åŠ è½½å® ç‰©æ•°æ®
    function loadPetsData() {
      Papa.parse('pet.csv', {
        download: true,
        header: true,
        complete: (result) => {
          // è¾…åŠ©ï¼šæŠŠå¯èƒ½çš„å­—ç¬¦ä¸²æ•°å€¼è½¬æ¢ä¸º Numberï¼Œå¤„ç†åƒä½åˆ†éš”ç¬¦å’Œç©ºå€¼
          const toNum = (v) => {
            if (v === null || v === undefined) return 0;
            const s = String(v).replace(/[,\s]/g, '').trim();
            const n = Number(s);
            return Number.isFinite(n) ? n : 0;
          };

          petsData = result.data.map(pet => {
            return {
              ...pet,
              id: (() => { const n = Number(String(pet.ç¼–å·||'').trim()); return Number.isFinite(n)? n : 0; })(),
              é­”åŠ›å€¼: toNum(pet['é­”åŠ›å€¼']),
              é­”åŠ›: toNum(pet['é­”åŠ›å€¼']),
              magic: toNum(pet['é­”åŠ›å€¼']),
              ç²¾åŠ›: toNum(pet['ç²¾åŠ›']),
              energy: toNum(pet['ç²¾åŠ›']),
              ç‰©æ”»: toNum(pet['ç‰©æ”»']),
              é˜²å¾¡: toNum(pet['é˜²å¾¡']),
              é­”æ”»: toNum(pet['é­”æ”»']),
              é­”æŠ—: toNum(pet['é­”æŠ—']),
              é€Ÿåº¦: toNum(pet['é€Ÿåº¦']),
              æ€»å’Œ: toNum(pet['æ€»å’Œ'])
            };
          });
          
          // åˆå§‹æ¸²æŸ“
          filteredPets = [...petsData];
          renderPets();
        },
        error: (error) => {
          console.error('åŠ è½½å® ç‰©æ•°æ®å¤±è´¥:', error);
          petsGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
              <p class="text-red-500">åŠ è½½å® ç‰©æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
            </div>
          `;
        }
      });
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      // æœç´¢è¾“å…¥
      searchInput.addEventListener('input', (e) => {
        searchQuery = e.target.value.trim().toLowerCase();
        applyFilters();
      });
      
      // é­”åŠ›å€¼ç­›é€‰
      magicFilterBtn.addEventListener('click', () => {
        magicFilterActive = !magicFilterActive;
        magicFilterBtn.classList.toggle('bg-primary');
        magicFilterBtn.classList.toggle('text-white');
        magicFilterBtn.classList.toggle('border-primary');
        applyFilters();
      });
      
      // æ’åºé€‰æ‹©
      sortSelect.addEventListener('change', (e) => {
        sortOrder = e.target.value;
        applyFilters();
      });
      
      // å±æ€§ç­›é€‰
      filterButtons.forEach(button => {
        button.addEventListener('click', () => {
          // æ›´æ–°æ´»è·ƒçŠ¶æ€
          filterButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          currentFilter = button.dataset.type;
          applyFilters();
        });
      });

      // åœ¨ç­›é€‰æŒ‰é’®ä¸Šæ¸²æŸ“å›¾æ ‡
      filterButtons.forEach(btn => {
        const dtype = btn.dataset.type;
        const chi = dataTypeToChinese[dtype];
        if (chi && typeIconMap[chi]) {
          // åœ¨æ–‡å­—å‰æ’å…¥å›¾æ ‡å°æ ‡ç­¾
          const iconSpan = document.createElement('span');
          iconSpan.className = 'mr-2';
          iconSpan.textContent = typeIconMap[chi];
          btn.prepend(iconSpan);
        }
      });
      
      // ç§»åŠ¨ç«¯èœå•
      mobileMenuButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
      
      // æ»šåŠ¨æ—¶å¯¼èˆªæ æ•ˆæœ
      window.addEventListener('scroll', () => {
        if (window.scrollY > 50) {
          navbar.classList.add('py-2', 'shadow');
          navbar.classList.remove('py-3', 'shadow-sm');
        } else {
          navbar.classList.add('py-3', 'shadow-sm');
          navbar.classList.remove('py-2', 'shadow');
        }
      });
      
      // æ¨¡æ€æ¡†æ§åˆ¶
      closeModal.addEventListener('click', closePetModal);
      modalBackdrop.addEventListener('click', closePetModal);
      // æˆ˜é˜Ÿé¢æ¿æ§åˆ¶
      teamToggle.addEventListener('click', () => {
        teamPanel.classList.toggle('hidden');
      });
      clearTeamBtn.addEventListener('click', () => {
        myTeam = [];
        renderTeam();
      });
      closeTeamBtn.addEventListener('click', () => teamPanel.classList.add('hidden'));
      // åˆå§‹æ¸²æŸ“æˆ˜é˜Ÿ
      renderTeam();
      
      // é”®ç›˜ESCå…³é—­æ¨¡æ€æ¡†
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !petModal.classList.contains('hidden')) {
          closePetModal();
        }
      });
    }
    
    // åº”ç”¨æ‰€æœ‰ç­›é€‰æ¡ä»¶
    function applyFilters() {
      let result = [...petsData];
      
      // æœç´¢ç­›é€‰
      if (searchQuery) {
        result = result.filter(pet => 
          pet.åç§°.toLowerCase().includes(searchQuery) || 
          pet.ç®€ä»‹.toLowerCase().includes(searchQuery)
        );
      }
      
      // å±æ€§ç­›é€‰
      if (currentFilter !== 'all') {
        // æ˜ å°„å‰ç«¯ç±»å‹åˆ°CSVä¸­çš„å±æ€§å€¼
        const typeMap = {
          'fire': 'ç«',
          'water': 'æ°´',
          'grass': 'è‰',
          'electric': 'ç”µ',
          'ice': 'å†°',
          'martial': 'æ­¦',
          'poison': 'æ¯’',
          'earth': 'åœŸ',
          'wing': 'ç¿¼',
          'cute': 'èŒ',
          'insect': 'è™«',
          'stone': 'çŸ³',
          'ghost': 'å¹½çµ',
          'dragon': 'é¾™',
          'devil': 'æ¶é­”',
          'mechanical': 'æœºæ¢°',
          'light': 'å…‰',
          'normal': 'æ™®é€š',
          'godgrass': 'ç¥è‰'
        };
        
        const targetType = typeMap[currentFilter];
        result = result.filter(pet => pet.ä¸» === targetType || pet.å‰¯ === targetType);
      }
      
      // é­”åŠ›å€¼ç­›é€‰
      if (magicFilterActive) {
        result = result.filter(pet => pet.magic > 0);
      }
      
      // æ’åº
      result.sort((a, b) => {
        switch (sortOrder) {
          case 'id-asc':
            return a.id - b.id;
          case 'id-desc':
            return b.id - a.id;
          case 'power-asc':
            return a.magic - b.magic;
          case 'power-desc':
            return b.magic - a.magic;
          case 'sum-asc':
            return a.æ€»å’Œ - b.æ€»å’Œ;
          case 'sum-desc':
            return b.æ€»å’Œ - a.æ€»å’Œ;
          default:
            return a.id - b.id;
        }
      });
      
      filteredPets = result;
      renderPets();
    }
    
    // æ¸²æŸ“å® ç‰©å¡ç‰‡
    function renderPets() {
      if (filteredPets.length === 0) {
        petsGrid.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      petsGrid.innerHTML = '';
      
      filteredPets.forEach(pet => {
        const card = createPetCard(pet);
        petsGrid.appendChild(card);
      });
    }

    // æ¸²æŸ“æˆ‘çš„æˆ˜é˜Ÿé¢æ¿å’Œæ‘˜è¦
    function renderTeam() {
      // æ›´æ–°é¡¶éƒ¨æ‘˜è¦
      teamCountEl.textContent = `é˜Ÿä¼ ${myTeam.length}/${maxTeamSize}`;
      const totalMagic = myTeam.reduce((s, p) => s + (Number(p.magic) || 0), 0);
      teamMagicEl.textContent = `é­”åŠ›: ${totalMagic}`;

      // é¢æ¿å†…éƒ¨
      panelCount.textContent = `(${myTeam.length}/${maxTeamSize})`;
      panelMagic.textContent = String(totalMagic);
      teamListEl.innerHTML = '';

      myTeam.forEach(p => {
        const item = document.createElement('div');
        item.className = 'relative bg-gray-50 rounded p-1 flex flex-col items-center text-xs';
        const img = document.createElement('img');
        let imageUrl = `https://res.17roco.qq.com/webapp/rocoBox/preview/${p.id}.png`;
        if (p.id === 0.5) imageUrl = 'pet-images/0.5.png';
        if (p.id === 0) imageUrl = 'pet-images/0.png';
        img.src = imageUrl;
        img.className = 'w-16 h-16 object-contain';
        const name = document.createElement('div');
        name.className = 'text-center text-xs mt-1';
        name.textContent = p.åç§° || '';
        const removeBtn = document.createElement('button');
        removeBtn.className = 'absolute top-0 right-0 text-red-500 text-xs';
        removeBtn.textContent = 'Ã—';
        removeBtn.addEventListener('click', () => {
          myTeam = myTeam.filter(t => String(t.id) !== String(p.id));
          renderTeam();
        });
        item.appendChild(img);
        item.appendChild(name);
        item.appendChild(removeBtn);
        teamListEl.appendChild(item);
      });
    }
    
    // åˆ›å»ºå® ç‰©å¡ç‰‡
    function createPetCard(pet) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow-md overflow-hidden card-hover';
      
      // ç¡®å®šä¸»å±æ€§å¯¹åº”çš„é¢œè‰²ç±»
      const typeColorMap = {
        'ç«': 'fire',
        'æ°´': 'water',
        'è‰': 'grass',
        'ç”µ': 'electric',
        'å†°': 'ice',
        'æ­¦': 'martial',
        'æ¯’': 'poison',
        'åœŸ': 'earth',
        'ç¿¼': 'wing',
        'èŒ': 'cute',
        'è™«': 'insect',
        'çŸ³': 'stone',
        'å¹½çµ': 'ghost',
        'é¾™': 'dragon',
        'æ¶é­”': 'devil',
        'æœºæ¢°': 'mechanical',
        'å…‰': 'light',
        'æ™®é€š': 'normal',
        'ç¥è‰': 'godgrass'
      };
      // ç±»å‹å›¾æ ‡æ˜ å°„ï¼ˆå¯æ›¿æ¢ä¸ºæ›´åˆé€‚çš„å›¾æ ‡ï¼‰
      const typeIconMap = {
        'ç«': 'ğŸ”¥', 'æ°´': 'ğŸ’§', 'è‰': 'ğŸƒ', 'ç”µ': 'âš¡', 'å†°': 'â„ï¸', 'æ­¦': 'ğŸ¥‹', 'æ¯’': 'â˜ ï¸', 'åœŸ': 'ğŸŒ', 'ç¿¼': 'ğŸ¦', 'èŒ': 'ğŸ˜»',
        'è™«': 'ğŸ', 'çŸ³': 'ğŸª¨', 'å¹½çµ': 'ğŸ‘»', 'é¾™': 'ğŸ‰', 'æ¶é­”': 'ğŸ˜ˆ', 'æœºæ¢°': 'âš™ï¸', 'å…‰': 'ğŸ’¡', 'æ™®é€š': 'â­', 'ç¥è‰': 'ğŸŒ¿'
      };
      
      const mainType = pet.ä¸» || 'normal';
      const mainTypeColor = typeColorMap[mainType] || 'normal';
      
      // å® ç‰©å›¾ç‰‡URL
      let imageUrl = `https://res.17roco.qq.com/webapp/rocoBox/preview/${pet.id}.png`;
      if (pet.id === 0.5) {
        imageUrl = 'pet-images/0.5.png';
      }
      else if (pet.id === 0) {
        imageUrl = 'pet-images/0.png';
      }
      
      // æ„å»ºå¡ç‰‡HTML
      card.innerHTML = `
        <div class="relative h-48 overflow-hidden bg-gradient-to-b from-${mainTypeColor}/10 to-white">
          <button class="absolute top-3 left-3 w-7 h-7 rounded-full bg-white/80 backdrop-blur-sm flex items-center justify-center text-gray-500 hover:text-red-500 transition-colors">
            <i class="fa fa-heart-o"></i>
          </button>
          
          <img src="${imageUrl}" alt="${pet.åç§°}" class="w-full h-full object-contain object-center transform transition-transform hover:scale-110 duration-500">
          
          <div class="absolute top-3 right-3 flex flex-wrap gap-1">
            <span class="bg-${mainTypeColor} text-white text-xs px-2 py-1 rounded-full">${typeIconMap[pet.ä¸»] || ''} ${pet.ä¸»}ç³»</span>
            ${pet.å‰¯ ? `<span class="bg-${typeColorMap[pet.å‰¯] || 'normal'} text-white text-xs px-2 py-1 rounded-full">${typeIconMap[pet.å‰¯] || ''} ${pet.å‰¯}ç³»</span>` : ''}
          </div>
        </div>
        
        <div class="p-4">
          <div class="flex justify-between items-start mb-2">
            <h3 class="font-bold text-lg">${pet.åç§°}</h3>
            <div class="flex">
              ${Array.from({length: 5}).map((_, i) => 
                i < pet.magic ? `<i class="fa fa-star text-yellow-400"></i>` : `<i class="fa fa-star-o text-gray-300"></i>`
              ).join('')}
            </div>
          </div>
          
          <p class="text-gray-500 text-sm mb-3">ç¼–å·: ${pet.id}</p>
          <p class="text-gray-600 text-sm mb-4 line-clamp-2">${pet.ç®€ä»‹ || 'æš‚æ— ä»‹ç»'}</p>
          
          <div class="flex justify-between items-center">
            <span class="text-gray-500 text-sm">ç§æ—å€¼: ${pet.æ€»å’Œ}</span>
            <button class="view-details bg-primary text-white px-3 py-1.5 rounded-lg text-sm hover:bg-primary/90 transition-colors" data-id="${pet.id}">
              æŸ¥çœ‹è¯¦æƒ…
            </button>
          </div>
        </div>
      `;
      
      // æ·»åŠ ç‚¹å‡»äº‹ä»¶æŸ¥çœ‹è¯¦æƒ…
      card.querySelector('.view-details').addEventListener('click', () => {
        openPetModal(pet);
      });
      
      return card;
    }
    
    // æ‰“å¼€å® ç‰©è¯¦æƒ…æ¨¡æ€æ¡†
    function openPetModal(pet) {
      // æ„å»ºæ¨¡æ€æ¡†å†…å®¹
      const typeColorMap = {
        'ç«': 'fire',
        'æ°´': 'water',
        'è‰': 'grass',
        'ç”µ': 'electric',
        'å†°': 'ice',
        'æ­¦': 'martial',
        'æ¯’': 'poison',
        'åœŸ': 'earth',
        'ç¿¼': 'wing',
        'èŒ': 'cute',
        'è™«': 'insect',
        'çŸ³': 'stone',
        'å¹½çµ': 'ghost',
        'é¾™': 'dragon',
        'æ¶é­”': 'devil',
        'æœºæ¢°': 'mechanical',
        'å…‰': 'light',
        'æ™®é€š': 'normal',
        'ç¥è‰': 'godgrass'
      };
      
      const mainType = pet.ä¸» || 'normal';
      const mainTypeColor = typeColorMap[mainType] || 'normal';
      
      // å® ç‰©å›¾ç‰‡URL
      let imageUrl = `https://res.17roco.qq.com/webapp/rocoBox/preview/${pet.id}.png`;
      if (pet.id === 0.5) {
        imageUrl = 'pet-images/0.5.png';
      }
      else if (pet.id === 0) {
        imageUrl = 'pet-images/0.png';
      }
      
      modalBody.innerHTML = `
        <div class="flex flex-col md:flex-row gap-6">
          <!-- å·¦ä¾§: å® ç‰©å›¾ç‰‡å’ŒåŸºæœ¬ä¿¡æ¯ -->
          <div class="md:w-1/3">
            <div class="bg-gradient-to-b from-${mainTypeColor}/20 to-white rounded-xl p-4 mb-4 text-center">
              <img src="${imageUrl}" alt="${pet.åç§°}" class="w-full max-w-xs mx-auto h-64 object-contain">
              <h2 class="text-2xl font-bold mt-4">${pet.åç§°}</h2>
              <p class="text-gray-500">ç¼–å·: ${pet.id}</p>
              
              <div class="flex justify-center gap-2 mt-3">
                <span class="bg-${mainTypeColor} text-white text-sm px-3 py-1 rounded-full">${pet.ä¸»}ç³»</span>
                ${pet.å‰¯ ? `<span class="bg-${typeColorMap[pet.å‰¯] || 'normal'} text-white text-sm px-3 py-1 rounded-full">${pet.å‰¯}ç³»</span>` : ''}
              </div>
              
              <div class="flex justify-center mt-2">
                ${Array.from({length: 5}).map((_, i) => 
                  i < pet.magic ? `<i class="fa fa-star text-yellow-400 text-lg"></i>` : `<i class="fa fa-star-o text-gray-300 text-lg"></i>`
                ).join('')}
              </div>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4">
              <h3 class="font-semibold mb-3">åŸºæœ¬ä¿¡æ¯</h3>
              <div class="space-y-2 text-sm">
                <p><span class="text-gray-500">ç»„åˆ«:</span> ${pet.ç»„åˆ« || 'æœªçŸ¥'}</p>
                <p><span class="text-gray-500">é­”åŠ›å€¼:</span> ${pet.magic}</p>
                <p><span class="text-gray-500">ç§æ—å€¼æ€»å’Œ:</span> ${pet.æ€»å’Œ}</p>
              </div>
            </div>
          </div>
          
          <!-- å³ä¾§: è¯¦ç»†ä¿¡æ¯ -->
          <div class="md:w-2/3">
            <div class="bg-gray-50 rounded-xl p-4 mb-6">
              <h3 class="font-semibold mb-3">å® ç‰©ä»‹ç»</h3>
              <p class="text-gray-700">${pet.ç®€ä»‹ || 'æš‚æ— è¯¦ç»†ä»‹ç»'}</p>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4 mb-6">
              <h3 class="font-semibold mb-4">ç§æ—å€¼è¯¦æƒ…</h3>
              
              <!-- ç§æ—å€¼å›¾è¡¨ -->
              <div class="h-64 mb-6">
                <canvas id="stats-chart"></canvas>
              </div>
              
              <!-- ç§æ—å€¼è¡¨æ ¼ -->
              <div class="grid grid-cols-3 sm:grid-cols-4 gap-3 text-sm">
                <div class="bg-white rounded-lg p-3 text-center">
                  <p class="text-gray-500">ç²¾åŠ›</p>
                  <p class="font-medium">${pet.ç²¾åŠ›}</p>
                </div>
                <div class="bg-white rounded-lg p-3 text-center">
                  <p class="text-gray-500">ç‰©æ”»</p>
                  <p class="font-medium">${pet.ç‰©æ”»}</p>
                </div>
                <div class="bg-white rounded-lg p-3 text-center">
                  <p class="text-gray-500">é˜²å¾¡</p>
                  <p class="font-medium">${pet.é˜²å¾¡}</p>
                </div>
                <div class="bg-white rounded-lg p-3 text-center">
                  <p class="text-gray-500">é­”æ”»</p>
                  <p class="font-medium">${pet.é­”æ”»}</p>
                </div>
                <div class="bg-white rounded-lg p-3 text-center">
                  <p class="text-gray-500">é­”æŠ—</p>
                  <p class="font-medium">${pet.é­”æŠ—}</p>
                </div>
                <div class="bg-white rounded-lg p-3 text-center">
                  <p class="text-gray-500">é€Ÿåº¦</p>
                  <p class="font-medium">${pet.é€Ÿåº¦}</p>
                </div>
                <div class="bg-white rounded-lg p-3 text-center col-span-3 sm:col-span-1">
                  <p class="text-gray-500">æ€»å’Œ</p>
                  <p class="font-medium">${pet.æ€»å’Œ}</p>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end">
              <button id="add-team-btn" data-id="${pet.id}" class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-colors">
                <i class="fa fa-plus mr-2"></i><span id="add-team-text">åŠ å…¥æˆ˜é˜Ÿ</span>
              </button>
            </div>
          </div>
        </div>
      `;
      
      // åˆ›å»ºç§æ—å€¼å›¾è¡¨
      setTimeout(() => {
        const ctx = document.getElementById('stats-chart').getContext('2d');
        // åŠ¨æ€è®¡ç®—å›¾è¡¨æœ€å¤§å€¼ï¼ŒåŸºäºå½“å‰å® ç‰©çš„å±æ€§
        const values = [pet.ç²¾åŠ›, pet.ç‰©æ”», pet.é˜²å¾¡, pet.é­”æ”», pet.é­”æŠ—, pet.é€Ÿåº¦].map(v => Number(v) || 0);
        const rawMax = Math.max(...values, 10);
        const chartMax = Math.ceil(rawMax / 10) * 10; // å‘ä¸Šå–æ•´ä¸º10çš„å€æ•°
        const step = Math.ceil(chartMax / 5);
        if (modalChart) {
          try { modalChart.destroy(); } catch(e){}
        }
        modalChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['ç²¾åŠ›', 'ç‰©æ”»', 'é˜²å¾¡', 'é­”æ”»', 'é­”æŠ—', 'é€Ÿåº¦'],
            datasets: [{
              label: 'ç§æ—å€¼',
              data: values,
              fill: true,
              backgroundColor: `rgba(123,97,255, 0.22)`,
              borderColor: `rgb(123,97,255)`,
              borderWidth: 2,
              tension: 0,
              pointBackgroundColor: `rgb(123,97,255)`,
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: `rgb(123,97,255)`
            }]
          },
          options: {
            elements: {
              line: {
                borderWidth: 2
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: chartMax,
                ticks: {
                  // éšè—å¾„å‘åˆ»åº¦æ•°å­—ï¼ˆé¿å…æ˜¾ç¤ºä¸ç›¸å…³çš„æ•°å€¼ï¼‰
                  display: false,
                  stepSize: step
                },
                angleLines: { display: true },
                grid: { circular: false }
              }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      }, 100);

      // ç»‘å®šåŠ å…¥æˆ˜é˜ŸæŒ‰é’®äº‹ä»¶
      const addBtn = modalBody.querySelector('#add-team-btn');
      const addBtnText = modalBody.querySelector('#add-team-text');
      const inTeam = myTeam.some(t => String(t.id) === String(pet.id));
      if (inTeam) addBtnText.textContent = 'å·²åœ¨æˆ˜é˜Ÿ';
      else addBtnText.textContent = 'åŠ å…¥æˆ˜é˜Ÿ';
      addBtn.addEventListener('click', () => {
        if (myTeam.some(t => String(t.id) === String(pet.id))) {
          // å¦‚æœå·²å­˜åœ¨åˆ™ç§»é™¤
          myTeam = myTeam.filter(t => String(t.id) !== String(pet.id));
        } else {
          if (myTeam.length >= maxTeamSize) {
            alert('æœ€å¤šåªèƒ½é€‰æ‹©6åªå® ç‰©åŠ å…¥æˆ˜é˜Ÿ');
            return;
          }
          myTeam.push(pet);
        }
        renderTeam();
        // æ›´æ–°æŒ‰é’®æ–‡æ¡ˆ
        const nowIn = myTeam.some(t => String(t.id) === String(pet.id));
        addBtnText.textContent = nowIn ? 'å·²åœ¨æˆ˜é˜Ÿ' : 'åŠ å…¥æˆ˜é˜Ÿ';
      });
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶æ·»åŠ åŠ¨ç”»
      petModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
      
      // è§¦å‘åŠ¨ç”»
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
    }
    
    // å…³é—­å® ç‰©è¯¦æƒ…æ¨¡æ€æ¡†
    function closePetModal() {
      modalContent.classList.remove('scale-100', 'opacity-100');
      modalContent.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        petModal.classList.add('hidden');
        document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
      }, 300);
    }
  </script>
</body>
</html>